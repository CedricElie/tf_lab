variables:
  TF_ROOT: .
  GIT_STRATEGY: clone
  GCP_SA_KEY_FILE_PATH: /tmp/gcp-sa-key.json 

stages:
  - tf_setup
  - tf_check
  - tf_execution
  - tf_cleanup

# --- Global Cache Configuration ---
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ${TF_ROOT}/.terraform/

# --- Common Setup Template ---
.terraform_setup:
  image: hashicorp/terraform:1.5.6
  tags:
    - shared
  before_script: | # Use before_script for setup common to ALL jobs that need terraform
    set -euo pipefail
    echo "==> PATH: $PATH"
    terraform -version || { echo "Terraform not found in PATH. Aborting."; exit 1; }
    # Configure workspace
    cd $TF_ROOT
    # Authentication is only relevant for jobs that need to use gcloud; those jobs
    # (like ensure_backend_exists) override with an image that includes gcloud.

  after_script: | # Use after_script for cleanup, making it tolerant
    # Cleanup: Use 'rm -f' to suppress error if file is already gone
    rm -f $GCP_SA_KEY_FILE_PATH 

# üîë Stage: tf_setup

# Job: Ensure GCS backend exists before running Terraform init
ensure_backend_exists:
  image: google/cloud-sdk:slim
  extends: .terraform_setup
  stage: tf_setup
  before_script: | # Run steps to prepare Cloud SDK and Terraform when using Cloud SDK image
    set -euo pipefail
    which gcloud || { echo "ERROR: Google Cloud CLI not found in PATH. Aborting."; exit 1; }
    # 1. Authentication (Writes the key to a file)
    cat "$GCP_SA_KEY_FILE" > "$GCP_SA_KEY_FILE_PATH"
    export GOOGLE_APPLICATION_CREDENTIALS="$GCP_SA_KEY_FILE_PATH"
    gcloud auth activate-service-account --key-file="$GCP_SA_KEY_FILE_PATH"
    # 2. Install terraform if not present
    if ! command -v terraform >/dev/null; then
      echo "Terraform not found - installing..."
      apt-get update && apt-get install -y unzip curl gnupg
      TERRAFORM_VERSION=1.5.6
      curl -fsSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o /tmp/terraform.zip
      unzip /tmp/terraform.zip -d /usr/local/bin
      terraform -version
    fi
    cd $TF_ROOT
  script:
    - set -euo pipefail
    - |
      # Determine project ID (prioritize TF var, then SA JSON content)
      PROJECT_ID=${TF_VAR_project:-}
      if [ -z "${PROJECT_ID:-}" ]; then
        if command -v python3 >/dev/null 2>&1; then
          PROJECT_ID=$(python3 -c "import json,sys;print(json.load(open('$GCP_SA_KEY_FILE_PATH')).get('project_id',''))")
        else
          echo "ERROR: TF_VAR_project unset and python3 not available to read the service account project_id"; exit 1
        fi
      fi
      REGION=${TF_VAR_region:-"europe-west9"}
      BACKEND_BUCKET="ocp-on-gcp-476018-tfstate"
      echo "Using project: ${PROJECT_ID}, region: ${REGION}, backend: ${BACKEND_BUCKET}"
      if gsutil ls -b gs://$BACKEND_BUCKET >/dev/null 2>&1; then
        echo "Backend bucket gs://$BACKEND_BUCKET already exists."
      else
        echo "Backend bucket gs://$BACKEND_BUCKET does not exist. Creating..."
        gsutil mb -p ${PROJECT_ID} -l ${REGION} -c STANDARD gs://$BACKEND_BUCKET
        # Enforce uniform bucket-level access and disable public access
        gsutil uniformbucketlevelaccess set on gs://$BACKEND_BUCKET || true
        echo "Backend bucket gs://$BACKEND_BUCKET created and configured."
      fi
  rules:
    - when: always

initialize_backend:
  extends: .terraform_setup
  stage: tf_setup
  needs:
    - ensure_backend_exists
  script:
    - echo "Initialize Terraform backend and providers"
    - terraform -version
    - terraform init -backend=true -input=false
  rules:
    - when: always

# üîí Stage: tf_check

# Job: validate_syntax
validate_syntax:
  extends: .terraform_setup
  stage: tf_check
  needs:
    - initialize_backend
  script:
    - terraform validate

# Job: create_plan
create_plan:
  extends: .terraform_setup
  stage: tf_check
  needs:
    - validate_syntax
  script:
    - terraform plan -out=plan.tfplan
  artifacts:
    paths:
      - $TF_ROOT/plan.tfplan
    expire_in: 1 day

# ‚úÖ Stage: tf_execution

# Job: deploy_infrastructure
deploy_infrastructure:
  extends: .terraform_setup
  stage: tf_execution
  needs:
    - create_plan
  script:
    - terraform apply -auto-approve plan.tfplan

# üóëÔ∏è Stage: tf_cleanup

# Job: destroy_resources
destroy_resources:
  extends: .terraform_setup
  stage: tf_cleanup
  script: |
    # Destruction Command
    echo "****************************************************************"
    echo "** WARNING: This will permanently destroy ALL managed resources. **"
    echo "****************************************************************"
    terraform destroy -auto-approve
  when: manual
