variables:
  TF_ROOT: .
  GIT_STRATEGY: clone
  GCP_SA_KEY_FILE_PATH: /tmp/gcp-sa-key.json 

stages:
  - tf_setup
  - tf_check
  - tf_execution
  - tf_cleanup

## ðŸ”‘ Stage: tf_setup

initialize_backend:
  stage: tf_setup
  tags:
    - shared
  script: |
    # Tool Checks
    which terraform || { echo "ERROR: Terraform not found in PATH. Aborting."; exit 1; }
    which gcloud || { echo "ERROR: Google Cloud CLI not found in PATH. Aborting."; exit 1; }
    
    # Authentication (Writes the key to a file)
    cat $GCP_SA_KEY_FILE > $GCP_SA_KEY_FILE_PATH
    gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    
    # ðŸ’¥ CRITICAL FIX 1: Set GOOGLE_APPLICATION_CREDENTIALS for Terraform
    export GOOGLE_APPLICATION_CREDENTIALS=$GCP_SA_KEY_FILE_PATH
    
    # Initialization
    cd $TF_ROOT
    terraform init 
    
    # Cleanup (Removes the key file)
    rm $GCP_SA_KEY_FILE_PATH
  rules:
    - when: always

## ðŸ”’ Stage: tf_check

# Job: validate_syntax
validate_syntax:
  stage: tf_check
  tags:
    - shared
  needs:
    - initialize_backend
  script: |
    # Authentication
    cat $GCP_SA_KEY_FILE > $GCP_SA_KEY_FILE_PATH
    
    # ðŸ’¥ CRITICAL FIX 2: Set GOOGLE_APPLICATION_CREDENTIALS
    export GOOGLE_APPLICATION_CREDENTIALS=$GCP_SA_KEY_FILE_PATH
    
    gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    cd $TF_ROOT
    
    terraform init
    terraform validate
    
    # Cleanup
    rm $GCP_SA_KEY_FILE_PATH

# Job: create_plan
create_plan:
  stage: tf_check
  tags:
    - shared
  needs:
    - validate_syntax
  script: |
    # Authentication
    cat $GCP_SA_KEY_FILE > $GCP_SA_KEY_FILE_PATH
    
    # ðŸ’¥ CRITICAL FIX 3: Set GOOGLE_APPLICATION_CREDENTIALS
    export GOOGLE_APPLICATION_CREDENTIALS=$GCP_SA_KEY_FILE_PATH
    
    gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    cd $TF_ROOT
    
    terraform init
    terraform plan -out=plan.tfplan
    
    # Cleanup
    rm $GCP_SA_KEY_FILE_PATH
  artifacts:
    paths:
      - $TF_ROOT/plan.tfplan
    expire_in: 1 day

## âœ… Stage: tf_execution

# Job: deploy_infrastructure
deploy_infrastructure:
  stage: tf_execution
  tags:
    - shared
  needs:
    - create_plan
  script: |
    # Authentication
    cat $GCP_SA_KEY_FILE > $GCP_SA_KEY_FILE_PATH
    
    # ðŸ’¥ CRITICAL FIX 4: Set GOOGLE_APPLICATION_CREDENTIALS
    export GOOGLE_APPLICATION_CREDENTIALS=$GCP_SA_KEY_FILE_PATH
    
    gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    cd $TF_ROOT
    
    terraform init
    terraform apply -auto-approve plan.tfplan
    
    # Cleanup
    rm $GCP_SA_KEY_FILE_PATH

## ðŸ—‘ï¸ Stage: tf_cleanup

# Job: destroy_resources
destroy_resources:
  stage: tf_cleanup
  tags:
    - shared
  script: |
    # Authentication
    cat $GCP_SA_KEY_FILE > $GCP_SA_KEY_FILE_PATH
    
    # ðŸ’¥ CRITICAL FIX 5: Set GOOGLE_APPLICATION_CREDENTIALS
    export GOOGLE_APPLICATION_CREDENTIALS=$GCP_SA_KEY_FILE_PATH
    
    gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    cd $TF_ROOT
    
    terraform init
    
    # Destruction Command
    echo "****************************************************************"
    echo "** WARNING: This will permanently destroy ALL managed resources. **"
    echo "****************************************************************"
    terraform destroy -auto-approve
    
    # Cleanup
    rm $GCP_SA_KEY_FILE_PATH
  when: manual
