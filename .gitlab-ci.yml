# --- Shell Executor Configuration ---
# DO NOT include an 'image' keyword when using a Shell Executor.

# Define global variables
variables:
  TF_ROOT: .
  GIT_STRATEGY: clone
  GCP_SA_KEY_FILE_PATH: /tmp/gcp-sa-key.json 

# Define the stages of the pipeline
stages:
  - init
  - validate
  - plan
  - apply
  - destroy

---

## ðŸ”‘ Stage: init (Guaranteed Visibility)

# This job initializes Terraform and ensures the pipeline is always visible.
init:
  stage: init
  tags:
    - shared # Explicitly assign the shared runner tag
  script:
    # Tool Checks
    - which terraform || { echo "ERROR: Terraform not found in PATH. Aborting."; exit 1; }
    - which gcloud || { echo "ERROR: Google Cloud CLI not found in PATH. Aborting."; exit 1; }
    
    # Initialization
    - cd $TF_ROOT
    - terraform init 
  # CRITICAL FIX: 'when: always' guarantees this job is scheduled, resolving the error.
  rules:
    - when: always 

---

## ðŸ”’ Stage: validate

validate:
  stage: validate
  tags:
    - shared
  needs:
    - init # Must run after init completes
  before_script:
    # 1. Authentication (GCP_SA_KEY_FILE must be a File variable in GitLab)
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    # 2. Navigate and re-init (if necessary, though main init handles provider download)
    - cd $TF_ROOT
  script:
    - terraform validate
  rules:
    - when: on_success # Runs automatically if 'init' succeeds

---

## ðŸ“ Stage: plan

plan:
  stage: plan
  tags:
    - shared
  needs:
    - validate
  before_script:
    # Authentication (as required for every job)
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    - cd $TF_ROOT
  script:
    - terraform plan -out=plan.tfplan
  artifacts:
    paths:
      - $TF_ROOT/plan.tfplan
    expire_in: 1 day
  rules:
    - when: on_success # Runs automatically if 'validate' succeeds

---

## âœ… Stage: apply

apply:
  stage: apply
  tags:
    - shared
  needs:
    - plan
  before_script:
    # Authentication (as required for every job)
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    - cd $TF_ROOT
  script:
    - terraform apply -auto-approve plan.tfplan
  # Rule: Only run automatically on the 'main' branch
  rules:
    - if: $CI_COMMIT_BRANCH == "main" 
      when: on_success 
    - when: never # Prevents running on feature branches

---

## ðŸ—‘ï¸ Stage: destroy (Manual)

destroy:
  stage: destroy
  tags:
    - shared
  before_script:
    # Authentication (as required for every job)
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    - cd $TF_ROOT
  script:
    - echo "****************************************************************"
    - echo "** WARNING: This will permanently destroy ALL managed resources. **"
    - echo "****************************************************************"
    - terraform destroy -auto-approve
  when: manual # Requires manual trigger
  rules:
    # Only allow the manual button to appear on the 'main' branch
    - if: $CI_COMMIT_BRANCH == "main"
