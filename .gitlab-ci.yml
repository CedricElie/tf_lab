# --- Shell Executor Configuration ---
# DO NOT include an 'image' keyword when using a Shell Executor.

# Define global variables
variables:
  TF_ROOT: .
  GIT_STRATEGY: clone
  GCP_SA_KEY_FILE_PATH: /tmp/gcp-sa-key.json 
  # Use CI_DEFAULT_BRANCH for clarity (usually main or master)
  DEFAULT_BRANCH: $CI_DEFAULT_BRANCH 

# Define the stages of the pipeline
stages:
  - init
  - validate
  - plan
  - apply
  - destroy

---

# --- Global Job Template ---
# All jobs inherit the runner tag
.shared_tags_template:
  tags:
    - shared

# --- Authentication and Init Script Template ---
# Contains the setup logic that runs before *most* jobs
.auth_and_init_script:
  before_script:
    # Check if required binaries are in the PATH
    - which terraform || { echo "ERROR: Terraform not found in PATH. Aborting."; exit 1; }
    - which gcloud || { echo "ERROR: Google Cloud CLI not found in PATH. Aborting."; exit 1; }
    
    # 1. Authenticate to Google Cloud
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH # Remove key file after use for security
    
    # 2. Navigate to the TF root and initialize
    - cd $TF_ROOT
    - terraform init

---

## üîë Stage: init (Visible Job)

# This job ensures pipeline visibility and performs mandatory setup.
init:
  extends: .shared_tags_template
  stage: init
  script:
    # These checks ensure basic tools are available
    - which terraform || { echo "ERROR: Terraform not found in PATH. Aborting."; exit 1; }
    - which gcloud || { echo "ERROR: Google Cloud CLI not found in PATH. Aborting."; exit 1; }
    - cd $TF_ROOT
    - terraform init # Initializes providers and backend state
  # RULE SIMPLIFICATION: This job runs automatically on all branches/tags.
  rules:
    - when: on_success # Always run automatically

---

## üîí Stage: validate

validate:
  extends: 
    - .shared_tags_template
    - .auth_and_init_script # Inherit auth and init setup
  stage: validate
  needs:
    - init 
  script:
    - terraform validate
  rules:
    - when: on_success # Always run automatically

---

## üìù Stage: plan

plan:
  extends: 
    - .shared_tags_template
    - .auth_and_init_script
  stage: plan
  needs:
    - validate
  script:
    - terraform plan -out=plan.tfplan
  artifacts:
    paths:
      - $TF_ROOT/plan.tfplan
    expire_in: 1 day
  rules:
    - when: on_success # Always run automatically

---

## ‚úÖ Stage: apply

apply:
  extends: 
    - .shared_tags_template
    - .auth_and_init_script
  stage: apply
  needs:
    - plan
  script:
    - terraform apply -auto-approve plan.tfplan
  # Only run apply on the default branch (where plan.tfplan is applied)
  rules:
    - if: $CI_COMMIT_BRANCH == $DEFAULT_BRANCH 
      when: on_success # Run automatically
    - when: never # Do not run on feature branches

---

## üóëÔ∏è Stage: destroy (Manual)

destroy:
  extends: 
    - .shared_tags_template
    - .auth_and_init_script
  stage: destroy
  # Requires manual trigger
  when: manual 
  rules:
    # Only allow the manual button to appear on the default branch
    - if: $CI_COMMIT_BRANCH == $DEFAULT_BRANCH
