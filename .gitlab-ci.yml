# --- Shell Executor Configuration ---
# REMOVE the 'image' line. Shell executors use the host machine environment.
# image: hashicorp/terraform:latest

# Define global variables
variables:
  TF_ROOT: .
  GIT_STRATEGY: clone

# Define the stages of the pipeline
stages:
  - validate
  - plan
  - apply
  - destroy # Added destroy stage

# --- Common Job Configuration for Shell Executor ---
# All jobs will use this tag to target your specific runner
.shell_executor_template:
  tags:
    - shared
  # For Shell Executors, you must ensure 'terraform' and 'gcloud'
  # are available in the runner's PATH.
  before_script:
    - which terraform || { echo "Terraform not found in PATH on runner 'shared'. Aborting."; exit 1; }
    - which gcloud || { echo "Google Cloud CLI not found in PATH on runner 'shared'. Aborting."; exit 1; }
    
    # 1. Authenticate to Google Cloud (using a file variable)
    # This block is moved to a 'before_script' for all main jobs
    # to ensure authentication is performed before any Terraform command.
    - echo "$GCP_SA_KEY_FILE" > /tmp/key.json
    - gcloud auth activate-service-account --key-file=/tmp/key.json
    - rm /tmp/key.json # Remove key file after use for security
    - cd $TF_ROOT
    - terraform init

# --- Pipeline Jobs ---

# The 'validate' job checks the configuration syntax
validate:
  extends: .shell_executor_template
  stage: validate
  script:
    - terraform validate

# The 'plan' job creates an execution plan, which is stored as an artifact
plan:
  extends: .shell_executor_template
  stage: plan
  script:
    # Run the plan and save it to a file
    - terraform plan -out=plan.tfplan
  artifacts:
    paths:
      - $TF_ROOT/plan.tfplan
    expire_in: 1 day
  # Only run plan on non-main branches or merge requests
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# The 'apply' job executes the plan
apply:
  extends: .shell_executor_template
  stage: apply
  needs:
    - plan
  script:
    # Apply the saved plan
    - terraform apply -auto-approve plan.tfplan
  # Only run apply on the main branch
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# --- Optional: Manual Infrastructure Destruction ---

# The 'destroy' job removes the infrastructure
destroy:
  extends: .shell_executor_template
  stage: destroy
  when: manual # Requires manual click to run
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Only allow destroy from the main branch
  script:
    - echo "WARNING: Running terraform destroy will permanently remove ALL managed resources."
    # The 'before_script' handles init and auth
    - terraform destroy -auto-approve
