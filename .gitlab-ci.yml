# --- Shell Executor Configuration ---

variables:
  TF_ROOT: .
  GIT_STRATEGY: clone
  # Variable for the Service Account Key file path
  GCP_SA_KEY_FILE_PATH: /tmp/gcp-sa-key.json 

# Define the new, descriptive stages of the pipeline
stages:
  - tf_setup       # Initialization and Authentication
  - tf_check       # Validation and Planning
  - tf_execution   # Apply
  - tf_cleanup     # Destroy

---

## ðŸ”‘ Stage: tf_setup

# Job: initialize_backend (Replaces 'init')
# This job is guaranteed to run first, ensuring pipeline visibility.
initialize_backend:
  stage: tf_setup
  tags:
    - shared
  script:
    # 1. Tool Checks (Essential for Shell Executor)
    - which terraform || { echo "ERROR: Terraform not found in PATH. Aborting."; exit 1; }
    - which gcloud || { echo "ERROR: Google Cloud CLI not found in PATH. Aborting."; exit 1; }
    
    # 2. Authentication (Necessary for 'terraform init' with GCS backend)
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    
    # 3. Initialization
    - cd $TF_ROOT
    - terraform init 
  # CRITICAL: Runs always to guarantee pipeline visibility
  rules:
    - when: always 

---

## ðŸ”’ Stage: tf_check

# Job: validate_syntax (Replaces 'validate')
validate_syntax:
  stage: tf_check
  tags:
    - shared
  needs:
    - initialize_backend
  script:
    # Authentication must be repeated as no 'before_script' is used
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    - cd $TF_ROOT
    - terraform validate

# Job: create_plan (Replaces 'plan')
create_plan:
  stage: tf_check
  tags:
    - shared
  needs:
    - validate_syntax
  script:
    # Authentication
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    - cd $TF_ROOT
    - terraform plan -out=plan.tfplan
  artifacts:
    paths:
      - $TF_ROOT/plan.tfplan
    expire_in: 1 day

---

## âœ… Stage: tf_execution

# Job: deploy_infrastructure (Replaces 'apply')
# âš ï¸ WARNING: This runs automatically on ALL branches since rules were removed.
deploy_infrastructure:
  stage: tf_execution
  tags:
    - shared
  needs:
    - create_plan
  script:
    # Authentication
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    - cd $TF_ROOT
    - terraform apply -auto-approve plan.tfplan

---

## ðŸ—‘ï¸ Stage: tf_cleanup

# Job: destroy_resources (Replaces 'destroy')
destroy_resources:
  stage: tf_cleanup
  tags:
    - shared
  script:
    # Authentication
    - echo "$GCP_SA_KEY_FILE" > $GCP_SA_KEY_FILE_PATH
    - gcloud auth activate-service-account --key-file=$GCP_SA_KEY_FILE_PATH
    - rm $GCP_SA_KEY_FILE_PATH
    - cd $TF_ROOT
    - echo "****************************************************************"
    - echo "** WARNING: This will permanently destroy ALL managed resources. **"
    - echo "****************************************************************"
    - terraform destroy -auto-approve
  when: manual # Explicitly manual trigger
